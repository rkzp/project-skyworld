[gd_resource type="Sky" load_steps=10 format=3 uid="uid://hweixg1tlws7"]

[ext_resource type="Texture2D" uid="uid://cn01dqt5l3lng" path="res://skybox_shenanigans/skybox.exr" id="1_67n0i"]

[sub_resource type="Shader" id="Shader_mblp0"]
code = "shader_type sky;

global uniform mat3 focus_position;
uniform sampler2D nightsky;
uniform sampler2D brightness_gradient: repeat_disable;
uniform sampler2D sky_color_gradient: repeat_disable;
uniform sampler2D sun_gradient: repeat_disable;

vec2 sphereUV(vec3 direction) { return vec2((atan(direction.x, direction.z) + PI) / (2.0 * PI), (asin(direction.y) + PI / 2.0) / PI); }

void sky() {
	vec3 eyedir_mirrored = EYEDIR;//vec3(EYEDIR.xz, abs(EYEDIR.y)).xzy;
	vec3 eyedir_planetlocal = eyedir_mirrored * inverse(focus_position);
	vec2 UV = sphereUV(eyedir_planetlocal);
	vec4 nightsky_sample = texture(nightsky, UV);
	//COLOR = vec3(0.0);
	COLOR = nightsky_sample.xyz * nightsky_sample.xyz * 50.0;
	if (LIGHT0_ENABLED){
		float daylight_power = dot(vec3(0.0, 1.0, 0.0), LIGHT0_DIRECTION);
		vec4 sky_gradient_sample = texture(brightness_gradient, vec2(dot(eyedir_mirrored, vec3(0.0, 1.0, 0.0)), 0.0));
		vec4 sky_color_sample = texture(sky_color_gradient, vec2(fma(daylight_power, 0.5, 0.5), 0.0));
		vec4 proc_sky_sample = sky_gradient_sample * sky_color_sample;
		
		vec4 sun_sample = texture(sun_gradient, vec2(dot(EYEDIR, LIGHT0_DIRECTION))) * clamp(sign(daylight_power), 0.0, 1.0);
		
		vec3 daylight_color = mix(proc_sky_sample.rgb, sun_sample.rgb, sun_sample.a);
		COLOR = mix(COLOR, daylight_color, proc_sky_sample.a);
	}
}
"

[sub_resource type="Gradient" id="Gradient_ovmgd"]
interpolation_mode = 2
offsets = PackedFloat32Array(0, 0.25, 1)
colors = PackedColorArray(1, 1, 1, 1, 0.75, 0.75, 0.75, 1, 0.151042, 0.151042, 0.151042, 1)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_dgen3"]
gradient = SubResource("Gradient_ovmgd")

[sub_resource type="Gradient" id="Gradient_g4rik"]
interpolation_mode = 2
offsets = PackedFloat32Array(0.4, 0.5, 0.7)
colors = PackedColorArray(0.5, 0.283333, 0.25, 0, 1, 0.533333, 0.458824, 1, 0.364706, 0.713726, 1, 1)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_116v7"]
gradient = SubResource("Gradient_g4rik")

[sub_resource type="Gradient" id="Gradient_b3m08"]
interpolation_mode = 2
offsets = PackedFloat32Array(0, 0.9, 1)
colors = PackedColorArray(1, 1, 1, 0, 1, 1, 1, 0.1, 1, 1, 1, 0.25)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_d8g8q"]
gradient = SubResource("Gradient_b3m08")
width = 1024
use_hdr = true

[sub_resource type="ShaderMaterial" id="ShaderMaterial_edej5"]
shader = SubResource("Shader_mblp0")
shader_parameter/nightsky = ExtResource("1_67n0i")
shader_parameter/brightness_gradient = SubResource("GradientTexture1D_dgen3")
shader_parameter/sky_color_gradient = SubResource("GradientTexture1D_116v7")
shader_parameter/sun_gradient = SubResource("GradientTexture1D_d8g8q")

[resource]
sky_material = SubResource("ShaderMaterial_edej5")
process_mode = 3
